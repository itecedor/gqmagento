<?php
/**
*
* Do not edit or add to this file if you wish to upgrade the module to newer
* versions in the future. If you wish to customize the module for your
* needs please contact us to https://www.milople.com/contact-us.html
*
* @category    Ecommerce
* @package     Milople_Requestforquote
* @copyright   Copyright (c) 2017 Milople Technologies Pvt. Ltd. All Rights Reserved.
* @url         https://www.milople.com/magento2-extension/call-for-price-m2.html
*
**/
use Magento\Framework\App\Action\Action;

// @codingStandardsIgnoreFile

?>	
<?php
/**
 * Product list template
 *
 * @var $block \Magento\Catalog\Block\Product\ListProduct
 */
?>
<?php 
$requestforquote_helper=$this->helper('Milople\Requestforquote\Helper\Requestforquote');
$enquiry_form_title = $this->helper('Milople\Requestforquote\Helper\Data')->getConfig('requestforquote/tag_setting_group/enquiry_form_title');
$countryCollection = $requestforquote_helper->getCountries();
$baseurl = $this->helper('Milople\Requestforquote\Helper\Data')->getBaseUrl() . 'requestforquote/index/save';
$tnc = $this->helper('Milople\Requestforquote\Helper\Data')->getConfig('requestforquote/tag_setting_group/show_terms_and_conditions');
?>
<div id="popup-mpdal" style="display:none;width:90%">
	<form id="enquiry_form">
		<input type="text" name="productname" id="pname" style="display:none;"/>
		<input type="text" name="producturl" id="purl" style="display:none;"/>
		Name:
		<input type="text" name="firstname" id="name" required/><br><br>
		E-mail:
		<input type="email" name="email" id="email" required/><br><br>
		<label for="country_name">Country : </label>
		<input id="country_name" name="country_name" type="text" list="country" required/><br><br>
			<datalist id="country">
				<?php foreach( $countryCollection as $label ): ?>
					<?php if($label['label']==' '): ?>
						<?php continue; ?>
					<?php endif; ?>
					<option value="<?php print_r($label['label']);?>">
				<?php endforeach; ?>
			</datalist>
		Phone Number:<br>
		<input type="number" name="phone_number" id="phone"><br><br>
		Description:<br>
		<textarea name="description" id="description" required/></textarea><br>
		<?php if($tnc==true):?>
			<input type="checkbox" id="chk_tnc"name="termsandconditions" class="checkbox_style" required/> I agree to the terms and conditions
		<?php endif; ?>
	</form>
</div>
<?php
$_productCollection = $block->getLoadedProductCollection();
$_helper = $this->helper('Magento\Catalog\Helper\Output');
$requestforquote_helper=$this->helper('Milople\Requestforquote\Helper\Requestforquote');
$enquiry_form_title = $this->helper('Milople\Requestforquote\Helper\Data')->getConfig('requestforquote/tag_setting_group/enquiry_form_title');
$countryCollection = $requestforquote_helper->getCountries();
$baseurl = $this->helper('Milople\Requestforquote\Helper\Data')->getBaseUrl() . 'requestforquote/index/save';
?>
<?php if (!$_productCollection->count()): ?>
    <div class="message info empty"><div><?php /* @escapeNotVerified */ echo __('We can\'t find products matching the selection.') ?></div></div>
<?php else: ?>
    <?php echo $block->getToolbarHtml() ?>
    <?php echo $block->getAdditionalHtml() ?>
    <?php
    if ($block->getMode() == 'grid') {
        $viewMode = 'grid';
        $image = 'category_page_grid';
        $showDescription = false;
        $templateType = \Magento\Catalog\Block\Product\ReviewRendererInterface::SHORT_VIEW;
    } else {
        $viewMode = 'list';
        $image = 'category_page_list';
        $showDescription = true;
        $templateType = \Magento\Catalog\Block\Product\ReviewRendererInterface::FULL_VIEW;
    }
    /**
     * Position for actions regarding image size changing in vde if needed
     */
    $pos = $block->getPositioned();
    ?>
    <div class="products wrapper <?php /* @escapeNotVerified */ echo $viewMode; ?> products-<?php /* @escapeNotVerified */ echo $viewMode; ?>">
        <?php $iterator = 1; ?>
		<ol class="products list items product-items">
            <?php /** @var $_product \Magento\Catalog\Model\Product */ ?>
            <?php foreach ($_productCollection as $_product): ?>
				<?php $textcolor = $this->helper('Milople\Requestforquote\Helper\Data')->getConfig('requestforquote/tag_setting_group/color'); ?>
				<?php $enableflag = $this->helper('Milople\Requestforquote\Helper\Data')->getConfig('requestforquote/license_status_group/status'); ?>
                <?php $check_rfq = ((($_product->getEnableRequestforquote() and $enableflag == 'specific_products') || ($enableflag == 'all_products')) and $requestforquote_helper->isValidCustomer()); ?>
				<?php $enable_enquire_button = $this->helper('Milople\Requestforquote\Helper\Data')->getConfig('requestforquote/tag_setting_group/show_enquiry_button'); ?>
				<?php /* @escapeNotVerified */ echo($iterator++ == 1) ? '<li class="item product product-item">' : '</li><li class="item product product-item">' ?>
                <div class="product-item-info" data-container="product-grid">
					<?php
                    $productImage = $block->getImage($_product, $image);
                    if ($pos != null) {
                        $position = ' style="left:' . $productImage->getWidth() . 'px;'
                            . 'top:' . $productImage->getHeight() . 'px;"';
                    }
                    ?>
                    <?php // Product Image ?>
                    <a href="<?php /* @escapeNotVerified */ echo $_product->getProductUrl() ?>" class="product photo product-item-photo" tabindex="-1">
                        <?php echo $productImage->toHtml(); ?>
                    </a>
                    <div class="product details product-item-details">
                        <?php
                            $_productNameStripped = $block->stripTags($_product->getName(), null, true);
                        ?>
                        <strong class="product name product-item-name">
                            <a class="product-item-link"
                               href="<?php /* @escapeNotVerified */ echo $_product->getProductUrl() ?>">
                                <?php /* @escapeNotVerified */ echo $_helper->productAttribute($_product, $_product->getName(), 'name'); ?>
                            </a>
                        </strong>               
                        <?php echo $block->getReviewsSummaryHtml($_product, $templateType); ?>
                        <?php if($check_rfq == false):?>
							<?php /* @escapeNotVerified */ echo $block->getProductPrice($_product) ?>
						<?php endif; ?>
                        <?php echo $block->getProductDetailsHtml($_product); ?>
                        <div class="product-item-inner">
                            <div class="product actions product-item-actions"<?php echo strpos($pos, $viewMode . '-actions') ? $position : ''; ?>>								
								<div class="actions-primary"<?php echo strpos($pos, $viewMode . '-primary') ? $position : ''; ?>>
									<?php if ($_product->isSaleable()): ?>
										<?php $postParams = $block->getAddToCartPostParams($_product); ?>   
										<!--call for price condition-->
										<?php if($check_rfq == true):?>	
										<form>
                                            <input type="hidden" name="product" value="<?php /* @escapeNotVerified */ echo $postParams['data']['product']; ?>">
                                            <input type="hidden" name="<?php /* @escapeNotVerified */ echo Action::PARAM_NAME_URL_ENCODED; ?>" value="<?php /* @escapeNotVerified */ echo $postParams['data'][Action::PARAM_NAME_URL_ENCODED]; ?>">
                                            <?php echo $block->getBlockHtml('formkey')?>                                           
											<button type="button"
                                                    title="<?php echo $block->escapeHtml(__('Call for Price')); ?>"
                                                    class="action tocart primary requestforquote_button">
                                                <span class="text_style"><?php /* @escapeNotVerified */ echo $this->helper('Milople\Requestforquote\Helper\Data')->getConfig('requestforquote/tag_setting_group/call_us_on_label'); ?></span>
                                            </button>											
											<!--Show Enquire Now Condition-->
											<?php if($enable_enquire_button == true):?>
												<div style="margin-top:5%;">
													<button type="button"
														id="enquire_now_btn"
														title="<?php echo $block->escapeHtml(__('Enquire Now')); ?>"
														data-name="<?php echo $_product->getName() ?>"
														url="<?php echo $_product->getProductUrl(); ?>"
														class="action tocart primary enquire_now_btn">
														<span><?php /* @escapeNotVerified */ echo $this->helper('Milople\Requestforquote\Helper\Data')->getConfig('requestforquote/tag_setting_group/enquire_now_button_text'); ?></span>
													</button>
												</div>
											<?php endif; ?>
                                        </form>
										<?php else: ?>
										<form data-role="tocart-form" action="<?php /* @escapeNotVerified */ echo $postParams['action']; ?>" method="post">
                                            <input type="hidden" name="product" value="<?php /* @escapeNotVerified */ echo $postParams['data']['product']; ?>">
                                            <input type="hidden" name="<?php /* @escapeNotVerified */ echo Action::PARAM_NAME_URL_ENCODED; ?>" value="<?php /* @escapeNotVerified */ echo $postParams['data'][Action::PARAM_NAME_URL_ENCODED]; ?>">
                                            <?php echo $block->getBlockHtml('formkey')?>
                                            <button type="submit"
                                                    title="<?php echo $block->escapeHtml(__('Add to Cart')); ?>"
                                                    class="action tocart primary">
                                                <span><?php /* @escapeNotVerified */ echo __('Add to Cart') ?></span>
                                            </button>
                                        </form>
										<?php endif; ?>
                                    <?php else: ?>
                                        <?php if ($_product->getIsSalable()): ?>
                                            <div class="stock available"><span><?php /* @escapeNotVerified */ echo __('In stock') ?></span></div>
                                        <?php else: ?>
                                            <div class="stock unavailable"><span><?php /* @escapeNotVerified */ echo __('Out of stock') ?></span></div>
                                        <?php endif; ?>
                                    <?php endif; ?>
                                </div>								
								<div data-role="add-to-links" class="actions-secondary"<?php echo strpos($pos, $viewMode . '-secondary') ? $position : ''; ?>>
                                    <?php if ($addToBlock = $block->getChildBlock('addto')): ?>
                                        <?php echo $addToBlock->setProduct($_product)->getChildHtml(); ?>
                                    <?php endif; ?>
                                </div>
                            </div>
                            <?php if ($showDescription):?>
                                <div class="product description product-item-description">
                                    <?php /* @escapeNotVerified */ echo $_helper->productAttribute($_product, $_product->getShortDescription(), 'short_description') ?>
                                    <a href="<?php /* @escapeNotVerified */ echo $_product->getProductUrl() ?>" title="<?php /* @escapeNotVerified */ echo $_productNameStripped ?>"
                                       class="action more"><?php /* @escapeNotVerified */ echo __('Learn More') ?></a>
                                </div>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
                <?php echo($iterator == count($_productCollection)+1) ? '</li>' : '' ?>
            <?php endforeach; ?>
        </ol>
    </div>
    <?php echo $block->getToolbarHtml() ?>
    <?php if (!$block->isRedirectToCartEnabled()) : ?>
        <script type="text/x-magento-init">
        {
            "[data-role=tocart-form], .form.map.checkout": {
                "catalogAddToCart": {}
            }
        }
        </script>
    <?php endif; ?>
<?php endif; ?>
<script>
    require(
        [
            'jquery',
            'Magento_Ui/js/modal/modal'
        ],
        function(
            $,
            modal
        ) {
            var options = {
                type: 'popup',
                responsive: true,
                innerScroll: true,
                title: '<?php echo $enquiry_form_title;?> for <?php /* @escapeNotVerified */ echo $_helper->productAttribute($_product, $_product->getName(), 'name'); ?>',
                buttons: [{
					text: $.mage.__('Clear'),
                    class: '',
                    click: function () {
						document.getElementById("name").value='';
						document.getElementById("email").value='';
						document.getElementById("country_name").value='';
						document.getElementById("phone").value='';
						document.getElementById("description").value='';
					}						
				},{
                    text: $.mage.__('Submit'),
                    class: '',
                    click: function () {
						var formData=new FormData(jQuery('#enquiry_form')[0]);
						var name=document.getElementById("name").value;
						var email=document.getElementById("email").value;
						var country=document.getElementById("country_name").value;
						var phone=document.getElementById("phone").value;
						var description=document.getElementById("description").value;
						var done;
						formData.append("name",name );
						formData.append("email", email);
						formData.append("country", country);
						formData.append("phone", phone);
						formData.append("description", description);
						formData.append("pname",document.getElementById("pname").value);
						formData.append("purl",document.getElementById("purl").value);
						if(<?php echo $tnc;?>==true)
						{
							var chk_tnc=document.getElementById("chk_tnc").checked;;
							if(chk_tnc==true)agree='done';
						}
						if(<?php echo $tnc;?>==false)
						{
							agree='done';
						}
						if(name!='' && email!='' && country!='' && description!='' && agree=='done'){
						$.ajax({
							url: "<?php echo $baseurl ?>",
							data:formData ,
							showLoader: true,
							cache: false,
							type: 'post',
							processData: false,
							contentType: false,
							}).done(function(data){
								$( "aside" ).removeClass( "_show" );
								$("div.modals-overlay").remove();
								document.getElementById("description").value='';
						});
						agree=null;
						this.closeModal();		
						}
						
                    }
                }]
            };

            var popup = modal(options, $('#popup-mpdal'));
            $(".enquire_now_btn").on('click',function(){
				var product_name_popup = $(this).attr('data-name');
				var product_url = $(this).attr('url');
                $("#popup-mpdal").modal("openModal");
				document.getElementById("pname").value=product_name_popup;
				document.getElementById("purl").value=product_url;
				jQuery(".modal-title").html("<?php echo $enquiry_form_title;?>" + " for "+product_name_popup);
            });

        }
    );
</script>
<style>
.requestforquote_button{
	background-color:white !important;
	cursor:initial !important;
}
.text_style{
	color:<?php echo   $textcolor ?>;
	word-wrap: break-word;
	font-size: 13px;
}
.checkbox_style{
		margin-top: 5px !important;
}
</style>